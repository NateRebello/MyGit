#!/usr/bin/env python3
# Adds files to the index for staging

import os
import sys
import shutil
def main():
    program_name = os.path.basename(sys.argv[0])
    if len(sys.argv) < 2:
        print(f"usage: {program_name} <filenames>", file=sys.stderr)
        sys.exit(1)
    
    if not os.path.exists(".mygit"):
        print(f"{program_name}: error: mygit repository directory .mygit not found", file=sys.stderr)
        sys.exit(1)
    
    index_dir = ".mygit/index"
    for filename in sys.argv[1:]:
        index_path = os.path.join(index_dir, filename)
        if os.path.exists(filename):
            try:
                with open(filename, "r"):
                    pass
                if not os.path.isfile(filename):
                    print(f"{program_name}: error: can not add '{filename}' (not a regular file)", file=sys.stderr)
                    sys.exit(1)
                shutil.copy2(filename, index_path)
            except FileNotFoundError:
                print(f"{program_name}: error: can not open '{filename}'", file=sys.stderr)
                sys.exit(1)
            except OSError:
                print(f"{program_name}: error: can not add '{filename}'", file=sys.stderr)
                sys.exit(1)
        else:
            if os.path.exists(index_path):
                os.remove(index_path)
            else:
                print(f"{program_name}: error: can not open '{filename}'", file=sys.stderr)
                sys.exit(1)
if __name__ == "__main__":
    main()